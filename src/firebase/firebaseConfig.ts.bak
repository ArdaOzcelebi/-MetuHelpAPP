import { initializeApp, FirebaseApp } from "firebase/app";
import { getAuth, Auth } from "firebase/auth";

/**
 * Read env vars preferring NEXT_PUBLIC_* then plain FIREBASE_*.
 */
function env(key: string): string | undefined {
  return process.env[`NEXT_PUBLIC_${key}`] ?? process.env[key];
}

type FirebaseConfig = {
  apiKey?: string;
  authDomain?: string;
  projectId?: string;
  storageBucket?: string;
  messagingSenderId?: string;
  appId?: string;
  measurementId?: string;
};

const cfg: FirebaseConfig = {
  apiKey: env("FIREBASE_API_KEY"),
  authDomain: env("FIREBASE_AUTH_DOMAIN"),
  projectId: env("FIREBASE_PROJECT_ID"),
  storageBucket: env("FIREBASE_STORAGE_BUCKET"),
  messagingSenderId: env("FIREBASE_MESSAGING_SENDER_ID"),
  appId: env("FIREBASE_APP_ID"),
  measurementId: env("FIREBASE_MEASUREMENT_ID"),
};

export const REQUIRED_KEYS = [
  "NEXT_PUBLIC_FIREBASE_API_KEY",
  "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN",
  "NEXT_PUBLIC_FIREBASE_PROJECT_ID",
  "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET",
  "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID",
  "NEXT_PUBLIC_FIREBASE_APP_ID",
];

// Demo mode if required pieces are missing
export const DEMO_MODE = !(cfg.apiKey && cfg.projectId && cfg.appId);

if (DEMO_MODE) {
  // Friendly developer console output (safe, no secrets printed)
  // eslint-disable-next-line no-console
  console.warn("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
  // eslint-disable-next-line no-console
  console.warn("⚠️  Firebase environment variables not configured");
  // eslint-disable-next-line no-console
  console.warn("The app will run in demo mode.");
  // eslint-disable-next-line no-console
  console.warn("To enable authentication:");
  // eslint-disable-next-line no-console
  console.warn("1. Create a .env.local based on .env.example");
  // eslint-disable-next-line no-console
  console.warn("2. Add the NEXT_PUBLIC_FIREBASE_* values from your Firebase project");
  // eslint-disable-next-line no-console
  console.warn("3. Start the bundler with those envs (see FIREBASE_AUTH_SETUP.md)");
  // eslint-disable-next-line no-console
  console.warn("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
}

let firebaseApp: FirebaseApp | null = null;
let authInstance: Auth | null = null;

/**
 * Initialize Firebase only when not in demo mode.
 * Returns Auth instance or null (demo mode).
 */
export function initFirebase(): Auth | null {
  if (DEMO_MODE) return null;

  if (authInstance) return authInstance;

  try {
    if (!firebaseApp) {
      firebaseApp = initializeApp({
        apiKey: cfg.apiKey,
        authDomain: cfg.authDomain,
        projectId: cfg.projectId,
        storageBucket: cfg.storageBucket,
        messagingSenderId: cfg.messagingSenderId,
        appId: cfg.appId,
      } as any);
    }
    authInstance = getAuth(firebaseApp);
    // eslint-disable-next-line no-console
    console.log("Firebase initialized");
    return authInstance;
  } catch (err) {
    // eslint-disable-next-line no-console
    console.error("Failed to initialize Firebase:", err);
    throw new Error("Firebase initialization failed. Please check your configuration.");
  }
}

/**
 * Return Auth instance or null when running in demo mode.
 */
export function getAuthInstance(): Auth | null {
  if (DEMO_MODE) return null;
  if (!authInstance) return initFirebase();
  return authInstance;
}
