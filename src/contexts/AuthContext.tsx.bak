import React, { createContext, useContext, useEffect, useState } from 'react';
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut as firebaseSignOut,
  onAuthStateChanged,
  sendEmailVerification as firebaseSendEmailVerification,
  updateProfile as firebaseUpdateProfile,
  User,
} from 'firebase/auth';
import { getAuthInstance } from '../firebase/firebaseConfig';

type AuthContextValue = {
  user: User | null;
  loading: boolean;
  signUp: (email: string, password: string) => Promise<void>;
  signIn: (email: string, password: string) => Promise<void>;
  signOut: () => Promise<void>;
  sendEmailVerification: () => Promise<void>;
  updateProfileDisplayName: (displayName: string) => Promise<void>;
};

const AuthContext = createContext<AuthContextValue | undefined>(undefined);

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState<boolean>(true);

  useEffect(() => {
    let unsub: (() => void) | undefined;

    try {
      const auth = getAuthInstance();
      unsub = onAuthStateChanged(auth, (u) => {
        setUser(u);
        setLoading(false);
      });
    } catch (err) {
      // Firebase not configured or other error — do not throw during module import
      // eslint-disable-next-line no-console
      console.warn('[AuthProvider] Firebase not configured or failed to initialize:', err);
      setLoading(false);
    }

    return () => {
      if (unsub) unsub();
    };
  }, []);

  async function signUp(email: string, password: string) {
    try {
      const auth = getAuthInstance();
      const credential = await createUserWithEmailAndPassword(auth, email, password);
      // send verification email (non-blocking)
      try {
        await firebaseSendEmailVerification(credential.user);
      } catch (e) {
        // ignore failing verification send for now
        // eslint-disable-next-line no-console
        console.warn('[signUp] sendEmailVerification failed', e);
      }
    } catch (err) {
      throw err;
    }
  }

  async function signIn(email: string, password: string) {
    try {
      const auth = getAuthInstance();
      const cred = await signInWithEmailAndPassword(auth, email, password);
      if (!cred.user) throw new Error('Sign-in failed');
    } catch (err) {
      throw err;
    }
  }

  async function signOut() {
    try {
      const auth = getAuthInstance();
      await firebaseSignOut(auth);
      setUser(null);
    } catch (err) {
      // If firebase isn't configured, just ignore
      // eslint-disable-next-line no-console
      console.warn('[signOut] failed (firebase may be missing):', err);
    }
  }

  async function sendEmailVerification() {
    const auth = getAuthInstance();
    if (!auth.currentUser) throw new Error('No authenticated user');
    await firebaseSendEmailVerification(auth.currentUser);
  }

  async function updateProfileDisplayName(displayName: string) {
    const auth = getAuthInstance();
    if (!auth.currentUser) throw new Error('No authenticated user');
    await firebaseUpdateProfile(auth.currentUser, { displayName });
    setUser({ ...auth.currentUser } as User);
  }

  return (
    <AuthContext.Provider
      value={{
        user,
        loading,
        signUp,
        signIn,
        signOut,
        sendEmailVerification,
        updateProfileDisplayName,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
};

export function useAuth(): AuthContextValue {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error('useAuth must be used within AuthProvider');
  return ctx;
}